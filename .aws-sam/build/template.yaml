AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Alertly Backend v2 - NO VPC: API and Cronjobs without VPC for optimal
  performance'
Parameters:
  DBUser:
    Type: String
    Description: Database username for the RDS instance
  DBPass:
    Type: String
    Description: Database password for the RDS instance
    NoEcho: true
  DBHost:
    Type: String
    Description: Database host
  DBPort:
    Type: String
    Description: Database port
  DBName:
    Type: String
    Description: Database name
  GinMode:
    Type: String
    Description: Gin framework mode (release or debug)
    Default: release
  ImageBaseURL:
    Type: String
    Description: Base URL for images (CDN)
    Default: https://cdn.alertly.ca
Resources:
  alertlyapifunction:
    Type: AWS::Serverless::Function
    Properties:
      PackageType: Image
      Architectures:
      - x86_64
      MemorySize: 1024
      Timeout: 120
      Policies:
      - S3FullAccessPolicy:
          BucketName: alertly-images-production
      Environment:
        Variables:
          DB_USER:
            Ref: DBUser
          DB_PASS:
            Ref: DBPass
          DB_HOST:
            Ref: DBHost
          DB_PORT:
            Ref: DBPort
          DB_NAME:
            Ref: DBName
          GIN_MODE:
            Ref: GinMode
          IMAGE_BASE_URL:
            Ref: ImageBaseURL
      Events:
        CatchAll:
          Type: Api
          Properties:
            Path: /{proxy+}
            Method: ANY
      ImageUri: alertlyapifunction:api-v1
    Metadata:
      DockerContext: /Users/garyeikoow/Documents/www/alertly/backend
      DockerTag: api-v1
      Dockerfile: Dockerfile.api.simple
      SamResourceId: alertlyapifunction
  alertlycronjobfunction:
    Type: AWS::Serverless::Function
    Properties:
      PackageType: Image
      Architectures:
      - x86_64
      MemorySize: 512
      Timeout: 900
      Environment:
        Variables:
          DB_USER:
            Ref: DBUser
          DB_PASS:
            Ref: DBPass
          DB_HOST:
            Ref: DBHost
          DB_PORT:
            Ref: DBPort
          DB_NAME:
            Ref: DBName
          GIN_MODE:
            Ref: GinMode
      Events:
        NewClusterSchedule:
          Type: Schedule
          Properties:
            Name: alertly-new-cluster-schedule
            Description: Runs the new cluster job every minute
            Schedule: rate(1 minute)
            Input: '{"task": "new_cluster"}'
        BlockUserSchedule:
          Type: Schedule
          Properties:
            Name: alertly-block-user-schedule
            Description: Runs the block user job every hour
            Schedule: rate(1 hour)
            Input: '{"task": "block_user"}'
        BlockIncidentSchedule:
          Type: Schedule
          Properties:
            Name: alertly-block-incident-schedule
            Description: Runs the block incident job every minute
            Schedule: rate(1 minute)
            Input: '{"task": "block_incident"}'
        InactivityReminderSchedule:
          Type: Schedule
          Properties:
            Name: alertly-inactivity-reminder-schedule
            Description: Runs the inactivity reminder job every day at 8 AM
            Schedule: cron(0 8 * * ? *)
            Input: '{"task": "inactivity_reminder"}'
        BadgeEarnSchedule:
          Type: Schedule
          Properties:
            Name: alertly-badge-earn-schedule
            Description: Runs the badge earn job every 10 minutes
            Schedule: rate(10 minutes)
            Input: '{"task": "badge_earn"}'
        UserRankSchedule:
          Type: Schedule
          Properties:
            Name: alertly-user-rank-schedule
            Description: Runs the user rank job every day at 8 AM
            Schedule: cron(0 8 * * ? *)
            Input: '{"task": "user_rank"}'
        CommentsSchedule:
          Type: Schedule
          Properties:
            Name: alertly-comments-schedule
            Description: Runs the comments job every minute
            Schedule: rate(1 minute)
            Input: '{"task": "comments"}'
        IncidentUpdateSchedule:
          Type: Schedule
          Properties:
            Name: alertly-incident-update-schedule
            Description: Runs the incident update job every minute
            Schedule: rate(1 minute)
            Input: '{"task": "incident_update"}'
        IncidentExpirationSchedule:
          Type: Schedule
          Properties:
            Name: alertly-incident-expiration-schedule
            Description: Runs the incident expiration job every 5 minutes
            Schedule: rate(5 minutes)
            Input: '{"task": "incident_expiration"}'
      ImageUri: alertlycronjobfunction:cron-v1
    Metadata:
      DockerContext: /Users/garyeikoow/Documents/www/alertly/backend
      DockerTag: cron-v1
      Dockerfile: Dockerfile.cronjob.simple
      SamResourceId: alertlycronjobfunction
Outputs:
  AlertlyApiEndpoint:
    Description: API Gateway endpoint URL for Prod stage for Alertly function
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/
